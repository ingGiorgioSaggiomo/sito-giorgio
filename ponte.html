<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Progetta il Ponte Ingegnere!</title>
<style>
    body {
        margin: 0;
        font-family: 'Comic Sans MS', cursive, sans-serif;
        background: #cce6ff;
        overflow: hidden;
    }
    #toolbar {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255,255,255,0.9);
        padding: 10px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 10;
    }
    button, select {
        padding: 5px 10px;
        font-size: 14px;
        border-radius: 5px;
        border: 1px solid #444;
        cursor: pointer;
    }
    #pannelloGuida {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #333;
        box-shadow: 0px 4px 12px rgba(0,0,0,0.3);
        z-index: 20;
        text-align: center;
    }
    #pannelloGuida button {
        margin-top: 15px;
        background-color: #4CAF50;
        color: white;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        padding: 8px 14px;
    }
    #cronometro {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255,255,255,0.8);
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: bold;
        font-size: 18px;
        z-index: 10;
    }
    canvas {
        display: block;
        background: #cce6ff;
    }
</style>
</head>
<body>

<div id="toolbar">
    <button id="btnVincolo">Vincolo a terra</button>
    <select id="tipoVincolo">
        <option value="cerniera">Cerniera</option>
        <option value="incastro">Incastro</option>
    </select>
    <button id="btnAsta">Aggiungi asta</button>
    <button id="btnPiano">Piano di percorrenza</button>
    <button id="btnAnnulla">Annulla ultima asta</button>
    <button id="btnAvvia">Avvia simulazione</button>
    <button id="btnReset">Reset</button>
</div>

<div id="cronometro">Tempo: 0.0s</div>

<div id="pannelloGuida">
    <h2>Progetta il Ponte Ingegnere!</h2>
    <p>Collega i nodi con aste per creare un ponte stabile.<br>
    Posiziona fino a 4 vincoli a terra (cerniera o incastro) solo sulla terraferma.<br>
    Quando sei pronto, premi Avvia e fai attraversare il camioncino.<br>
    Vince chi attraversa senza crolli per almeno 6 secondi.</p>
    <button id="btnHoCapito">Ho capito</button>
</div>

<canvas id="giocoCanvas" width="1200" height="600"></canvas>

<script>
document.addEventListener('DOMContentLoaded', () => {
// ===== Variabili globali =====
const canvas = document.getElementById('giocoCanvas');
const ctx = canvas.getContext('2d');

let nodi = [];
let aste = [];
let vincoli = [];
let pianoPercorrenza = [];
let modalita = null;
let vincoliPosizionati = 0;
const MAX_VINCOLI = 4;
let guidaMostrata = true; // Mostrata solo al primo caricamento, non reimpostare mai su reset
let inSimulazione = false;
let tempoTrascorso = 0;
let timerAttivo = false;
let camion = null;
let pezziCrollati = [];

// ===== Funzione disegno schermata iniziale =====
function disegnaSchermataIniziale() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // Sfondo azzurro cielo
    ctx.fillStyle = "#cce6ff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Disegno colline cartoon
    ctx.fillStyle = "#66cc66";
    ctx.beginPath();
    ctx.moveTo(0, 400);
    ctx.quadraticCurveTo(200, 300, 400, 400);
    ctx.lineTo(0, 600);
    ctx.closePath();
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(800, 400);
    ctx.quadraticCurveTo(1000, 300, 1200, 400);
    ctx.lineTo(1200, 600);
    ctx.closePath();
    ctx.fill();

    // Fiume/mare
    ctx.fillStyle = "#3399ff";
    ctx.fillRect(0, 400, canvas.width, 200);

    // Titolo
    ctx.fillStyle = "#ff6600";
    ctx.font = "bold 48px Comic Sans MS";
    ctx.textAlign = "center";
    ctx.fillText("Progetta il Ponte Ingegnere!", canvas.width/2, 100);

    // Testo istruzioni
    ctx.fillStyle = "#000";
    ctx.font = "20px Comic Sans MS";
    ctx.fillText("Collega nodi e aste per un ponte stabile", canvas.width/2, 450);
    ctx.fillText("Posiziona fino a 4 vincoli a terra", canvas.width/2, 480);
    ctx.fillText("Premi Avvia per far passare il camion", canvas.width/2, 510);

    // Disegna il pulsante "Ho Capito"
    const btnX = canvas.width / 2 - 50;
    const btnY = 530;
    const btnW = 100;
    const btnH = 40;
    ctx.fillStyle = "#4CAF50";
    ctx.fillRect(btnX, btnY, btnW, btnH);
    ctx.strokeStyle = "#333";
    ctx.strokeRect(btnX, btnY, btnW, btnH);
    ctx.fillStyle = "#fff";
    ctx.font = "18px Comic Sans MS";
    ctx.textAlign = "center";
    ctx.fillText("Ho Capito", canvas.width/2, btnY + 26);

    console.log("Schermata iniziale disegnata con pulsante 'Ho Capito'"); // Debug
}

// Disegna subito schermata iniziale

// Mostra schermata iniziale o sfondo gioco in base a guidaMostrata
if (guidaMostrata) {
    disegnaSchermataIniziale();
    document.getElementById("pannelloGuida").style.display = "block";
} else {
    disegnaSfondoGioco();
}

// Gestione "Ho Capito"
const btnHoCapito = document.getElementById("btnHoCapito");
if (btnHoCapito) {
    btnHoCapito.addEventListener("click", () => {
        console.log("btnHoCapito click ricevuto");
        const pannello = document.getElementById("pannelloGuida");
        pannello.style.display = "none";
        pannello.style.visibility = "hidden";
        pannello.style.pointerEvents = "none";
        guidaMostrata = false; // forza il passaggio allo stato "gioco"
        disegnaSfondoGioco();
    });
} else {
    console.error("btnHoCapito non trovato");
}
// ===== Funzione disegno sfondo di gioco =====
function disegnaSfondoGioco() {
    // cielo
    ctx.fillStyle = "#cce6ff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // terraferma sinistra
    ctx.fillStyle = "#66cc66";
    ctx.beginPath();
    ctx.moveTo(0, 400);
    ctx.quadraticCurveTo(200, 300, 400, 400);
    ctx.lineTo(0, 600);
    ctx.closePath();
    ctx.fill();

    // terraferma destra
    ctx.beginPath();
    ctx.moveTo(800, 400);
    ctx.quadraticCurveTo(1000, 300, 1200, 400);
    ctx.lineTo(1200, 600);
    ctx.closePath();
    ctx.fill();

    // mare/fiume
    ctx.fillStyle = "#3399ff";
    ctx.fillRect(0, 400, canvas.width, 200);
}

// ===== Funzioni disegno elementi =====
function disegnaNodi() {
    ctx.fillStyle = "#000";
    nodi.forEach(n => {
        ctx.beginPath();
        ctx.arc(n.x, n.y, 5, 0, Math.PI*2);
        ctx.fill();
    });
}

function disegnaAste() {
    aste.forEach(a => {
        ctx.strokeStyle = a.tipo === "piano" ? "#aa0000" : "#000";
        ctx.lineWidth = a.tipo === "piano" ? 3 : 2;
        ctx.beginPath();
        ctx.moveTo(a.n1.x, a.n1.y);
        ctx.lineTo(a.n2.x, a.n2.y);
        ctx.stroke();
    });
}

function disegnaVincoli() {
    ctx.fillStyle = "#555";
    vincoli.forEach(v => {
        ctx.fillRect(v.x-5, v.y, 10, 20);
        ctx.fillStyle = v.tipo === "cerniera" ? "#555" : "#222";
    });
}

// ===== Eventi pulsanti toolbar =====
document.getElementById("btnVincolo").addEventListener("click", () => {
    modalita = "vincolo";
});

document.getElementById("btnAsta").addEventListener("click", () => {
    modalita = "asta";
});

document.getElementById("btnPiano").addEventListener("click", () => {
    modalita = "piano";
});

document.getElementById("btnAnnulla").addEventListener("click", () => {
    aste.pop();
});

document.getElementById("btnReset").addEventListener("click", () => {
    nodi = [];
    aste = [];
    vincoli = [];
    pianoPercorrenza = [];
    vincoliPosizionati = 0;
    inSimulazione = false;
    tempoTrascorso = 0;
    timerAttivo = false;
    camion = null;
    pezziCrollati = [];
    document.getElementById("cronometro").innerText = "Tempo: 0.0s";
    document.getElementById("pannelloGuida").style.display = guidaMostrata ? "block" : "none";
    if (guidaMostrata) {
        disegnaSchermataIniziale();
    } else {
        disegnaSfondoGioco();
        disegnaNodi();
        disegnaAste();
        disegnaVincoli();
    }
});

document.getElementById("btnAvvia").addEventListener("click", () => {
    if (!inSimulazione) {
        if (guidaMostrata) {
            document.getElementById("pannelloGuida").style.display = "none";
            guidaMostrata = false;
        }
        avviaSimulazione();
    }
});

// ===== Gestione click/touch su canvas =====
canvas.addEventListener("click", e => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    console.log(`Click rilevato a (${x}, ${y})`); // Debug

    if (modalita === "vincolo" && vincoliPosizionati < MAX_VINCOLI) {
        const tipo = document.getElementById("tipoVincolo").value;
        // vincoli solo su terraferma
        if (èTerraferma(x, y)) {
            // Trova la y della terraferma in quel punto
            const yTerra = getYTerraferma(x);
            vincoli.push({x, y: yTerra, tipo});
            nodi.push({x, y: yTerra, vincolo: true});
            vincoliPosizionati++;
        }
    } else if (modalita === "asta" || modalita === "piano") {
        if (!nodoSelezionato) {
            nodoSelezionato = trovaNodoVicino(x,y);
        } else {
            const nodo2 = trovaNodoVicino(x,y) || aggiungiNodo(x,y);
            const tipoAsta = modalita === "piano" ? "piano" : "normale";
            aste.push({n1: nodoSelezionato, n2: nodo2, tipo: tipoAsta});
            if (tipoAsta === "piano") {
                pianoPercorrenza.push({n1: nodoSelezionato, n2: nodo2});
            }
            nodoSelezionato = null;
        }
    } else {
        // aggiungi nodo libero
        aggiungiNodo(x,y);
    }
});

document.getElementById("btnHoCapito").addEventListener("click", () => {
    document.getElementById("pannelloGuida").style.display = "none";
    guidaMostrata = false;
    disegnaSfondoGioco();
});

function trovaNodoVicino(x,y) {
    return nodi.find(n => Math.hypot(n.x-x, n.y-y) < 10);
}

function aggiungiNodo(x,y) {
    const n = {x, y};
    nodi.push(n);
    return n;
}

let nodoSelezionato = null;
// ===== Simulazione fisica =====
function avviaSimulazione() {
    inSimulazione = true;
    timerAttivo = true;
    tempoTrascorso = 0;
    cronometroInterval = setInterval(() => {
        if (timerAttivo) {
            tempoTrascorso += 0.1;
            document.getElementById("cronometro").innerText = `Tempo: ${tempoTrascorso.toFixed(1)}s`;
        }
    }, 100);

    // posiziona camioncino all'inizio del piano
    if (pianoPercorrenza.length > 0) {
        const inizio = pianoPercorrenza[0].n1.x < pianoPercorrenza[0].n2.x ? pianoPercorrenza[0].n1 : pianoPercorrenza[0].n2;
        camion = {x: inizio.x - 20, y: inizio.y - 10, vx: 1, vy: 0, larghezza: 20, altezza: 10};
    }

    // avvia loop fisico
    requestAnimationFrame(loopSimulazione);
}

function loopSimulazione() {
    if (!inSimulazione) return;

    // gravità su nodi non vincolati
    nodi.forEach(n => {
        if (!n.vincolo) {
            n.y += 0.5; // gravità base
        }
    });

    // verifica cinematismi (struttura labile)
    if (verificaCinematismo()) {
        crolloPonte();
        return;
    }

    // muovi camioncino lungo il piano
    if (camion) {
        camion.x += camion.vx;
        camion.y += camion.vy;
        // varia velocità con pendenza
        const segmento = trovaSegmentoPiano(camion.x);
        if (segmento) {
            const dx = segmento.n2.x - segmento.n1.x;
            const dy = segmento.n2.y - segmento.n1.y;
            const inclinazione = dy / dx;
            camion.vy = inclinazione * camion.vx;
        } else {
            // cade in acqua
            splash();
            sconfitta();
            return;
        }
        // condizione vittoria
        if (camion.x > canvas.width - 100) {
            vittoria();
            return;
        }
    }

    // disegno
    disegnaSfondoGioco();
    disegnaAste();
    disegnaNodi();
    disegnaVincoli();
    disegnaCamion();

    requestAnimationFrame(loopSimulazione);
}

function disegnaCamion() {
    if (!camion) return;
    ctx.fillStyle = "#ff0000";
    ctx.fillRect(camion.x, camion.y - camion.altezza, camion.larghezza, camion.altezza);
}

function trovaSegmentoPiano(xCamion) {
    return pianoPercorrenza.find(seg =>
        (xCamion >= Math.min(seg.n1.x, seg.n2.x) && xCamion <= Math.max(seg.n1.x, seg.n2.x))
    );
}

// ===== Verifica cinematismo =====
function verificaCinematismo() {
    // criterio semplificato: se nodi non vincolati si muovono oltre soglia senza resistenza
    // in un modello reale si userebbe F=Kx con rigidezze aste
    let nodiLiberi = nodi.filter(n => !n.vincolo);
    return nodiLiberi.some(n => n.y > 450); // soglia arbitraria di cedimento
}

// ===== Gestione crollo =====
function crolloPonte() {
    inSimulazione = false;
    timerAttivo = false;
    pezziCrollati = [...aste];
    aste = [];
    splash();
    sconfitta();
}

// ===== Effetto splash =====
function splash() {
    ctx.fillStyle = "rgba(255,255,255,0.6)";
    for (let i=0; i<10; i++) {
        ctx.beginPath();
        ctx.arc(camion.x + Math.random()*20, 580 + Math.random()*10, Math.random()*5, 0, Math.PI*2);
        ctx.fill();
    }
    if (audioSplash) audioSplash.play();
}

// ===== Vittoria / Sconfitta =====
function vittoria() {
    inSimulazione = false;
    timerAttivo = false;
    alert("Vittoria! Il camion ha attraversato il ponte!");
}

function sconfitta() {
    inSimulazione = false;
    timerAttivo = false;
    alert("Sconfitta! Il camion è caduto in acqua!");
    document.getElementById("cronometro").innerText = "Tempo: 0.0s";
    // ritorno a costruzione
    aste = [];
    pezziCrollati = [];
    pianoPercorrenza = [];
    camion = null;
    // vincoliPosizionati NON viene azzerato qui!
    nodi.forEach(n => n.vincolo = false);
    vincoli = [];
    // Ridisegna tutto
    disegnaSfondoGioco();
    disegnaNodi();
    disegnaAste();
    disegnaVincoli();
}
// ===== Funzione per verificare se (x, y) è su terraferma =====
function èTerraferma(x, y) {
    // Colline sinistra: da x=0 a x=400
    if (x >= 0 && x <= 400) {
        const yCollineSx = getYTerraferma(x);
        return y >= yCollineSx;
    }
    // Colline destra: da x=800 a x=1200
    if (x >= 800 && x <= 1200) {
        const yCollineDx = getYTerraferma(x);
        return y >= yCollineDx;
    }
    return false;
}

// Calcola la y della terraferma (colline) per un dato x
function getYTerraferma(x) {
    if (x >= 0 && x <= 400) {
        // Quadratic curve: moveTo(0,400) -> quadraticCurveTo(200,300,400,400)
        // y = a(x-0)^2 + b(x-0) + c, con c=400, passa per (200,300)
        // Semplice parabola simmetrica
        // y = 400 - 100 * (1 - ((x-0)/400)*2)^2
        let t = (x-0)/400;
        return 400 - 100 * Math.pow(1 - t*2, 2);
    }
    if (x >= 800 && x <= 1200) {
        // Quadratic curve: moveTo(800,400) -> quadraticCurveTo(1000,300,1200,400)
        let t = (x-800)/400;
        return 400 - 100 * Math.pow(1 - t*2, 2);
    }
    return 600; // fuori terraferma
}

// ===== Audio =====
let audioSplash = new Audio("splash.mp3"); // deve essere presente nella stessa cartella
}); // chiusura DOMContentLoaded
</script>
</body>
</html>
